<div class="container mt-4 p-0">
    <h3>Editar Usuario de Institución</h3>

    <div *ngIf="cargando" class="alert alert-info">Cargando usuario...</div>

    <div *ngIf="!cargando">
        <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">
            
            <!-- Nombres -->
            <div class="form-group">
                <label for="nombres" class="form-label">Nombres</label>
                <input id="nombres" type="text" formControlName="nombres" class="form-control">
            </div>

            <!-- Apellidos -->
            <div class="form-group mt-3">
                <label for="apellidos" class="form-label">Apellidos</label>
                <input id="apellidos" type="text" formControlName="apellidos" class="form-control">
            </div>

            <!-- RUT -->
            <div class="form-group mt-3">
                <label for="rut" class="form-label">RUT</label>
                <input id="rut" type="text" formControlName="rut" class="form-control">
                <small class="form-text text-muted">
                    Ingresar sin puntos y con guion final. Ejemplo: 12345678-9
                </small>
            </div>

            <!-- Sexo -->
            <mat-form-field class="w-100 mt-3">
                <mat-label>Seleccionar Sexo</mat-label>
                <mat-select formControlName="sexo">
                    <mat-option value="M">Masculino</mat-option>
                    <mat-option value="F">Femenino</mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Fecha de Nacimiento -->
            <div class="form-group mt-3">
                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                <input id="fecha_nacimiento" type="date" formControlName="fecha_nacimiento" class="form-control">
            </div>

            <!-- Profesión -->
            <div class="form-group mt-3">
                <label for="profesion" class="form-label">Profesión</label>
                <textarea id="profesion" formControlName="profesion" class="form-control" rows="2"></textarea>
            </div>

            <!-- Email -->
            <div class="form-group mt-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input id="email" type="email" formControlName="email" class="form-control">
            </div>

            <!-- Rol (por defecto Profesional) -->
            <mat-form-field class="w-100 mt-3" appearance="outline">
                <mat-label>Seleccionar Rol</mat-label>
                <mat-select formControlName="rol">
                    <mat-option *ngFor="let r of roles" [value]="r">{{ r }}</mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Selección de Región -->
            <mat-form-field class="w-100 mt-3" appearance="outline">
                <mat-label>Seleccionar Región</mat-label>
                <mat-select formControlName="region_id" (selectionChange)="onRegionChange($event)">
                    <mat-option *ngFor="let region of regiones" [value]="region.id">
                        {{ region.nombre }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Selección de Provincia -->
            <mat-form-field class="w-100 mt-3" appearance="outline">
                <mat-label>Seleccionar Provincia</mat-label>
                <mat-select formControlName="provincia_id" (selectionChange)="onProvinciaChange($event)">
                    <mat-option *ngFor="let provincia of provincias" [value]="provincia.id">
                        {{ provincia.nombre }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Selección de Comuna -->
            <mat-form-field class="w-100 mt-3" appearance="outline">
                <mat-label>Seleccionar Comuna</mat-label>
                <mat-select formControlName="comuna_id">
                    <mat-option *ngFor="let comuna of comunas" [value]="comuna.id">
                        {{ comuna.nombre }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Seleccionar Institución -->
            <mat-form-field class="w-100 mt-3" appearance="outline">
                <mat-label>Seleccionar Institución</mat-label>
                <mat-select formControlName="institucion_id">
                <mat-option *ngFor="let institucion of instituciones" [value]="institucion.id">
                    {{ institucion.nombre_fantasia }}
                </mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Actualizar Contraseña -->
            <div class="form-group mt-3">
            <label for="password" class="form-label">Actualizar Contraseña (Opcional)</label>
            <input id="password" type="password" formControlName="password" class="form-control" placeholder="Solo si desea cambiarla">
            <small class="form-text text-muted">Deja este campo vacío si no deseas cambiar la contraseña</small>
            </div>

            <!-- Botones -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary ms-2" (click)="volver()">Volver</button>
            </div>
        </form>
    </div>
</div>
